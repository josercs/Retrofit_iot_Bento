apiVersion: 1
groups:
  - orgId: 1
    name: Edge Alerts
    folder: Edge
  interval: 1m0s
    rules:
      - uid: alert-edge-down
        title: Edge down (sem amostras)
        condition: C
        data:
          - refId: A
            datasourceUid: influxdb
            queryType: flux
            relativeTimeRange:
              from: 2m0s
              to: 0m0s
            model:
              query: |
                from(bucket: "processo")
                  |> range(start: -2m)
                  |> filter(fn: (r) => r["_measurement"] == "s7_db1")
                  |> limit(n:1)
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: $A
          - refId: C
            datasourceUid: __expr__
            model:
              type: classic_conditions
              conditions:
                - evaluator:
                    params: [0]
                    type: lt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: count
                  type: query
  for: 2m0s
        annotations:
          summary: "Sem dados do edge há >2m"
        labels: {}

      - uid: alert-high-latency
        title: Latência S7 alta
        condition: C
        data:
          - refId: A
            datasourceUid: influxdb
            queryType: flux
            relativeTimeRange:
              from: 5m0s
              to: 0m0s
            model:
              query: |
                from(bucket: "processo")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "prometheus" and r._field == "plc_read_latency_ms")
                  |> mean()
          - refId: C
            datasourceUid: __expr__
            model:
              type: classic_conditions
              conditions:
                - evaluator:
                    params: [250]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
  for: 5m0s
        annotations:
          summary: "Latência média > 250 ms"

      - uid: alert-publish-failures
        title: Falhas de publicação > 0/min
        condition: C
        data:
          - refId: A
            datasourceUid: influxdb
            queryType: flux
            relativeTimeRange:
              from: 2m0s
              to: 0m0s
            model:
              query: |
                from(bucket: "processo")
                  |> range(start: -2m)
                  |> filter(fn: (r) => r._measurement == "prometheus" and r._field == "plc_publish_fail_total")
                  |> derivative(nonNegative: true, unit: 1m)
                  |> sum()
          - refId: C
            datasourceUid: __expr__
            model:
              type: classic_conditions
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
  for: 2m0s
        annotations:
          summary: "Falhas de publicação/min > 0"
